<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Morningstar Style Box Mixer</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <style>
      :root {
        --bg: #0e1a2b;
        --card: #13253b;
        --muted: #7ba4c2;
        --accent: #6fffe9;
        --accent-2: #ffc857;
        --border: rgba(255, 255, 255, 0.08);
        --error: #ef476f;
        --warn: #ffa630;
        --success: #8cff98;
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        min-height: 100vh;
        font-family: "Space Grotesk", "Segoe UI", system-ui, -apple-system,
          sans-serif;
        background: radial-gradient(
            circle at 10% 20%,
            rgba(111, 255, 233, 0.12),
            transparent 25%
          ),
          radial-gradient(
            circle at 80% 0%,
            rgba(255, 200, 87, 0.12),
            transparent 28%
          ),
          linear-gradient(135deg, #0b1422, #0f1d30 50%, #0c1726);
        color: #e8f1f8;
        padding: 28px;
      }

      h1 {
        margin: 0 0 6px;
        font-weight: 700;
        letter-spacing: 0.4px;
      }

      p.lead {
        margin: 0 0 18px;
        color: var(--muted);
        max-width: 860px;
        line-height: 1.5;
      }

      .page {
        max-width: 1200px;
        margin: 0 auto 80px;
      }

      .card {
        background: var(--card);
        border: 1px solid var(--border);
        border-radius: 14px;
        padding: 18px 18px 16px;
        box-shadow: 0 20px 55px rgba(0, 0, 0, 0.35);
      }

      .cards-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
        gap: 16px;
        margin-bottom: 16px;
      }

      .section-title {
        margin: 0 0 12px;
        font-size: 15px;
        text-transform: uppercase;
        letter-spacing: 0.6px;
        color: #d8e5f3;
      }

      .control-row {
        display: flex;
        align-items: center;
        gap: 10px;
        flex-wrap: wrap;
        margin-bottom: 14px;
      }

      button {
        border: none;
        background: linear-gradient(135deg, var(--accent), #3bd6c2);
        color: #041120;
        font-weight: 700;
        padding: 10px 14px;
        border-radius: 10px;
        cursor: pointer;
        transition: transform 0.1s ease, box-shadow 0.2s ease;
        box-shadow: 0 8px 20px rgba(111, 255, 233, 0.25);
      }

      button.secondary {
        background: rgba(255, 255, 255, 0.06);
        color: #d3e8f6;
        box-shadow: none;
        border: 1px solid var(--border);
      }

      button:active {
        transform: translateY(1px);
      }

      .style-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 6px;
      }

      .style-grid label {
        display: flex;
        flex-direction: column;
        gap: 4px;
        background: rgba(255, 255, 255, 0.04);
        padding: 8px;
        border-radius: 8px;
        border: 1px solid var(--border);
        font-size: 12px;
        color: #c7d9e8;
      }

      .style-grid input {
        width: 100%;
        padding: 7px 8px;
        border-radius: 6px;
        border: 1px solid transparent;
        background: rgba(0, 0, 0, 0.2);
        color: #e8f1f8;
        font-size: 13px;
      }

      .style-grid input:focus {
        outline: none;
        border-color: var(--accent);
      }

      .fund-card {
        border-left: 4px solid rgba(111, 255, 233, 0.6);
      }

      .fund-meta {
        display: flex;
        gap: 8px;
        margin-bottom: 10px;
      }

      .fund-meta input,
      .fund-meta select {
        flex: 1;
        padding: 8px 10px;
        border-radius: 8px;
        border: 1px solid var(--border);
        background: rgba(255, 255, 255, 0.05);
        color: #e8f1f8;
        font-size: 13px;
      }

      .fund-meta input::placeholder {
        color: #8ba7bd;
      }

      .alert {
        display: none;
        padding: 12px 14px;
        border-radius: 10px;
        border: 1px solid rgba(255, 255, 255, 0.08);
        margin-bottom: 12px;
        line-height: 1.4;
      }

      .alert.warn {
        background: rgba(255, 166, 48, 0.12);
        border-color: rgba(255, 166, 48, 0.4);
        color: #ffd69c;
      }

      .alert.error {
        background: rgba(239, 71, 111, 0.12);
        border-color: rgba(239, 71, 111, 0.45);
        color: #ffc8d4;
      }

      .results-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
        gap: 14px;
        margin-top: 10px;
      }

      .table {
        width: 100%;
        border-collapse: collapse;
        font-size: 13px;
      }

      .table th,
      .table td {
        text-align: left;
        padding: 8px;
        border-bottom: 1px solid var(--border);
      }

      .table th {
        color: #c7d9e8;
        font-weight: 600;
      }

      .badge {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 7px 10px;
        border-radius: 999px;
        background: rgba(255, 255, 255, 0.06);
        border: 1px solid var(--border);
        font-size: 12px;
        color: #d3e8f6;
        margin-right: 8px;
      }

      .metric {
        font-size: 26px;
        font-weight: 700;
        margin: 6px 0 4px;
        color: #fff;
      }

      .metric-label {
        color: var(--muted);
        font-size: 12px;
      }

      .style-compare {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        gap: 10px;
      }

      .style-box-visual {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 4px;
        margin-top: 10px;
      }

      .style-box-visual .cell {
        background: rgba(255, 255, 255, 0.04);
        border: 1px solid var(--border);
        border-radius: 6px;
        padding: 10px 8px 8px;
        text-align: center;
        font-size: 12px;
        color: #c7d9e8;
      }

      .style-box-visual .value {
        display: block;
        margin-top: 4px;
        font-weight: 700;
        color: #fff;
      }

      @media (max-width: 640px) {
        body {
          padding: 18px;
        }
        .fund-meta {
          flex-direction: column;
        }
      }
    </style>
  </head>
  <body>
    <div class="page">
      <h1>Style Box Mixer</h1>
      <p class="lead">
        Build a blend of up to four funds that mimics a target Morningstar-style
        box. Enter the nine-box exposure for your target and the funds you have,
        then solve for the non-negative weights that get you closest. Results
        show the suggested allocation, the blended box, and how far off you are.
      </p>

      <div class="control-row">
        <button id="solveBtn">Solve Allocation</button>
        <button class="secondary" id="sampleBtn">Load Sample Data</button>
        <span class="badge">Weights forced to 0–100% and sum to 100%</span>
      </div>

      <div id="validationAlert" class="alert error"></div>
      <div id="regionAlert" class="alert warn"></div>
      <div id="structureAlert" class="alert warn"></div>

      <div class="cards-grid">
        <div class="card">
          <div class="section-title">Target Style Box</div>
          <div class="style-grid" id="targetGrid"></div>
          <div id="targetSumNote" class="badge" style="margin-top: 10px">
            Expect total near 100%
          </div>
        </div>

        <div
          class="card fund-card"
          id="fundsContainer"
          style="grid-column: span 2"
        >
          <div class="section-title">Composite Funds (up to 4)</div>
          <div id="fundCards"></div>
        </div>
      </div>

      <div class="card">
        <div class="section-title">Suggested Mix & Fit</div>
        <div class="results-grid">
          <div>
            <div class="metric" id="errorMetric">–</div>
            <div class="metric-label">
              Sum of squared differences (lower is closer)
            </div>
            <table class="table" id="weightsTable"></table>
          </div>
          <div>
            <div class="style-compare">
              <div>
                <div class="badge">Target</div>
                <div class="style-box-visual" id="targetVisual"></div>
              </div>
              <div>
                <div class="badge">Blended Result</div>
                <div class="style-box-visual" id="blendVisual"></div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      // Row/column layout for the nine style-box entries: Large/Mid/Small x Value/Blend/Growth.
      const ROWS = ["Large", "Mid", "Small"];
      const COLS = ["Value", "Blend", "Growth"];
      const TOLERANCE = 5; // Acceptable +/- range around 100% for style-box totals.

      const targetGridEl = document.getElementById("targetGrid");
      const fundsContainer = document.getElementById("fundCards");
      const validationAlert = document.getElementById("validationAlert");
      const regionAlert = document.getElementById("regionAlert");
      const structureAlert = document.getElementById("structureAlert");
      const weightsTable = document.getElementById("weightsTable");
      const targetVisual = document.getElementById("targetVisual");
      const blendVisual = document.getElementById("blendVisual");
      const errorMetricEl = document.getElementById("errorMetric");

      // Build a 3x3 grid of inputs inside the provided element.
      function renderStyleGrid(el, prefix) {
        const fragment = document.createDocumentFragment();
        ROWS.forEach((row) => {
          COLS.forEach((col) => {
            const label = document.createElement("label");
            label.textContent = `${row} / ${col}`;
            const input = document.createElement("input");
            input.type = "number";
            input.step = "0.01";
            input.min = "0";
            input.placeholder = "0";
            input.dataset.key = `${prefix}-${row}-${col}`;
            label.appendChild(input);
            fragment.appendChild(label);
          });
        });
        el.appendChild(fragment);
      }

      // Create fund cards with name, region, and a 3x3 grid.
      function initFunds(count = 4) {
        fundsContainer.innerHTML = "";
        for (let i = 0; i < count; i++) {
          const card = document.createElement("div");
          card.className = "card fund-card";
          card.style.marginBottom = "12px";

          const meta = document.createElement("div");
          meta.className = "fund-meta";

          const nameInput = document.createElement("input");
          nameInput.placeholder = `Fund ${i + 1} name`;
          nameInput.dataset.key = `fund-${i}-name`;
          meta.appendChild(nameInput);

          const regionSelect = document.createElement("select");
          regionSelect.dataset.key = `fund-${i}-region`;
          ["", "US", "International", "Emerging", "Global", "Other"].forEach(
            (opt) => {
              const o = document.createElement("option");
              o.value = opt;
              o.textContent = opt || "Region";
              regionSelect.appendChild(o);
            }
          );
          meta.appendChild(regionSelect);

          card.appendChild(meta);
          const grid = document.createElement("div");
          grid.className = "style-grid";
          card.appendChild(grid);
          renderStyleGrid(grid, `fund-${i}`);
          fundsContainer.appendChild(card);
        }
      }

      renderStyleGrid(targetGridEl, "target");
      initFunds();

      // Read values from any grid by dataset prefix.
      function readStyleBox(prefix) {
        const values = [];
        ROWS.forEach((row) => {
          COLS.forEach((col) => {
            const input = document.querySelector(
              `input[data-key="${prefix}-${row}-${col}"]`
            );
            values.push(parseFloat(input.value) || 0);
          });
        });
        return values;
      }

      // Check totals and numeric validity; returns {ok, messages, total}.
      function validateStyleBox(values, label) {
        const messages = [];
        const total = values.reduce((a, b) => a + b, 0);
        if (values.some((v) => Number.isNaN(v))) {
          messages.push(`${label} has non-numeric entries.`);
        }
        if (Math.abs(total - 100) > TOLERANCE) {
          messages.push(
            `${label} totals ${total.toFixed(
              2
            )}%. Consider scaling toward 100%.`
          );
        }
        return { ok: messages.length === 0, messages, total };
      }

      // Projected gradient descent for non-negative weights that sum to 1.
      // A: matrix of size (9 x nFunds), t: target vector length 9.
      function optimizeWeights(A, t) {
        const n = A[0].length;
        let w = Array(n).fill(1 / n); // start equal
        const lr = 0.08;
        const iterations = 320;

        for (let iter = 0; iter < iterations; iter++) {
          const grad = Array(n).fill(0);
          // Compute gradient: 2 * A^T * (A w - t)
          for (let j = 0; j < 9; j++) {
            let dot = 0;
            for (let k = 0; k < n; k++) {
              dot += A[j][k] * w[k];
            }
            const diff = dot - t[j];
            for (let k = 0; k < n; k++) {
              grad[k] += 2 * A[j][k] * diff;
            }
          }
          // Gradient step then project back to non-negative simplex.
          for (let k = 0; k < n; k++) {
            w[k] = Math.max(0, w[k] - lr * grad[k]);
          }
          const sum = w.reduce((a, b) => a + b, 0);
          if (sum === 0) {
            w.fill(1 / n);
          } else {
            for (let k = 0; k < n; k++) w[k] /= sum;
          }
        }
        return w;
      }

      function sumSquaredError(blend, target) {
        return blend.reduce(
          (acc, val, idx) => acc + Math.pow(val - target[idx], 2),
          0
        );
      }

      function computeBlend(A, w) {
        const blend = Array(9).fill(0);
        for (let j = 0; j < 9; j++) {
          for (let k = 0; k < w.length; k++) {
            blend[j] += A[j][k] * w[k];
          }
        }
        return blend;
      }

      // Detect structural gaps: if every fund has ~0 in a cell but target wants more.
      function findStructuralGaps(funds, target) {
        const gaps = [];
        for (let i = 0; i < 9; i++) {
          const available = funds.every((f) => Math.abs(f.values[i]) < 0.001);
          if (available && target[i] > 1) {
            const row = ROWS[Math.floor(i / 3)];
            const col = COLS[i % 3];
            gaps.push(
              `${row} / ${col} exposure is unavailable in your composites while the target wants ${target[
                i
              ].toFixed(1)}%.`
            );
          }
        }
        return gaps;
      }

      function renderWeights(funds, weights) {
        weightsTable.innerHTML = "";
        const header = document.createElement("tr");
        header.innerHTML =
          "<th>Fund</th><th>Region</th><th>Suggested Weight</th>";
        weightsTable.appendChild(header);
        funds.forEach((f, idx) => {
          const row = document.createElement("tr");
          row.innerHTML = `<td>${f.name}</td><td>${f.region || "—"}</td><td>${(
            weights[idx] * 100
          ).toFixed(1)}%</td>`;
          weightsTable.appendChild(row);
        });
      }

      // Visual block for the nine cells.
      function renderBoxVisual(el, values) {
        el.innerHTML = "";
        values.forEach((v, i) => {
          const cell = document.createElement("div");
          cell.className = "cell";
          const label = `${ROWS[Math.floor(i / 3)]} / ${COLS[i % 3]}`;
          cell.innerHTML = `${label}<span class="value">${v.toFixed(
            1
          )}%</span>`;
          el.appendChild(cell);
        });
      }

      function showAlert(el, messages) {
        if (!messages || messages.length === 0) {
          el.style.display = "none";
          el.innerHTML = "";
          return;
        }
        el.style.display = "block";
        el.innerHTML = messages.join("<br>");
      }

      function solve() {
        validationAlert.style.display = "none";
        regionAlert.style.display = "none";
        structureAlert.style.display = "none";

        const target = readStyleBox("target");
        const targetCheck = validateStyleBox(target, "Target style box");
        const funds = [];

        for (let i = 0; i < 4; i++) {
          const name = document
            .querySelector(`input[data-key="fund-${i}-name"]`)
            .value.trim();
          const region = document.querySelector(
            `select[data-key="fund-${i}-region"]`
          ).value;
          const values = readStyleBox(`fund-${i}`);
          if (!name && values.every((v) => v === 0)) continue; // skip empty fund
          funds.push({ name: name || `Fund ${i + 1}`, region, values });
        }

        const messages = [];
        if (funds.length === 0) {
          messages.push("Please add at least one composite fund.");
        }
        const fundChecks = funds.map((f, idx) =>
          validateStyleBox(f.values, `${f.name || "Fund " + (idx + 1)}`)
        );
        const allMessages = [
          ...messages,
          ...fundChecks.flatMap((c) => c.messages),
        ];
        if (
          !targetCheck.ok ||
          messages.length > 0 ||
          fundChecks.some((c) => !c.ok)
        ) {
          showAlert(validationAlert, [...targetCheck.messages, ...allMessages]);
          return;
        } else {
          validationAlert.style.display = "none";
        }

        // Build matrix A (9 rows, n funds columns).
        const A = Array.from({ length: 9 }, (_, j) =>
          funds.map((f) => f.values[j] / 100)
        );
        const targetVector = target.map((v) => v / 100);

        // Detect region mixing.
        const regions = new Set(funds.map((f) => f.region).filter(Boolean));
        if (regions.size > 1) {
          showAlert(regionAlert, [
            "You are mixing funds from different regions. Identical style boxes across regions may still behave differently (currency, sector mix, accounting).",
          ]);
        } else {
          regionAlert.style.display = "none";
        }

        const weights = optimizeWeights(A, targetVector);
        const blend = computeBlend(A, weights).map((x) => x * 100);
        const error = sumSquaredError(blend, target);
        errorMetricEl.textContent = error.toFixed(2);

        renderWeights(funds, weights);
        renderBoxVisual(targetVisual, target);
        renderBoxVisual(blendVisual, blend);

        // Highlight structural limitations.
        const gaps = findStructuralGaps(funds, target);
        if (gaps.length > 0) {
          showAlert(structureAlert, gaps);
        } else {
          structureAlert.style.display = "none";
        }
      }

      function loadSample() {
        const targetInputs = {
          "target-Large-Value": 22,
          "target-Large-Blend": 33,
          "target-Large-Growth": 17,
          "target-Mid-Value": 6,
          "target-Mid-Blend": 8,
          "target-Mid-Growth": 6,
          "target-Small-Value": 3,
          "target-Small-Blend": 3,
          "target-Small-Growth": 2,
        };
        for (const key in targetInputs) {
          const el = document.querySelector(`input[data-key="${key}"]`);
          el.value = targetInputs[key];
        }

        const sampleFunds = [
          {
            name: "VFIAX (S&P 500)",
            region: "US",
            values: [25, 37, 20, 6, 8, 4, 0, 1, 0],
          },
          {
            name: "VIMAX (Mid Cap)",
            region: "US",
            values: [1, 2, 6, 31, 36, 24, 0, 0, 0],
          },
          {
            name: "VSMAX (Small Cap)",
            region: "US",
            values: [0, 0, 1, 4, 9, 16, 24, 28, 17],
          },
        ];

        sampleFunds.forEach((fund, i) => {
          document.querySelector(`input[data-key="fund-${i}-name"]`).value =
            fund.name;
          document.querySelector(`select[data-key="fund-${i}-region"]`).value =
            fund.region;
          ROWS.forEach((row, rIdx) => {
            COLS.forEach((col, cIdx) => {
              const idx = rIdx * 3 + cIdx;
              const el = document.querySelector(
                `input[data-key="fund-${i}-${row}-${col}"]`
              );
              el.value = fund.values[idx];
            });
          });
        });
      }

      document.getElementById("solveBtn").addEventListener("click", solve);
      document
        .getElementById("sampleBtn")
        .addEventListener("click", loadSample);
    </script>
  </body>
</html>
